# План инициализации доменных данных об аттракторах человеческого организма

## Обзор

Этот документ описывает план реализации инициализации доменных данных об аттракторах человеческого организма в существующую систему. Данные берутся из файла `parser/output.json`, который содержит иерархическую онтологию аттракторов.

## Требования к реализации

### Цель
Инициализировать в базе данных полную онтологию аттракторов человеческого организма, сохраняя:
- Иерархическую структуру данных
- Количественные характеристики (min/max значения)
- Многоязычную поддержку
- Совместимость с существующей архитектурой

### Исходные данные
- Файл: `parser/output.json`
- Структура: Иерархический JSON с полями `id`, `name`, `characteristic` (min/max), `children`
- Объем: Около 25,000 узлов иерархии

### Существующая архитектура
- Модель `ConceptModel`: Поддерживает иерархию через `parent_id`, `path`, `depth`
- Модель `DictionaryModel`: Связывает концепции с языками
- Модель `LanguageModel`: Поддерживаемые языки (ru, en, es, fr, de, zh, ja, ar)

## Подход к реализации

### 1. Создание скрипта инициализации

Создать новый скрипт `scripts/seed_domain_concepts.py` по аналогии с существующими:

```python
"""
Скрипт для инициализации доменных концепций аттракторов человеческого организма
"""
import json
import logging
import os
import sys

from core.database import SessionLocal
from languages.models import ConceptModel, DictionaryModel, LanguageModel

# Рекурсивная функция обработки узлов онтологии
def process_concept_node(db, node_data, parent_id=None, parent_path="", depth=0):
    # Создание концепции
    path = f"{parent_path}.{node_data['id']}" if parent_path else node_data['id']
    
    concept = ConceptModel(
        parent_id=parent_id,
        path=path,
        depth=depth
    )
    db.add(concept)
    db.flush()
    
    # Создание словарных записей для поддерживаемых языков
    create_dictionary_entries(db, concept.id, node_data['name'])
    
    # Рекурсивная обработка дочерних узлов
    for child in node_data.get('children', []):
        process_concept_node(db, child, concept.id, path, depth + 1)
    
    return concept

# Функция создания словарных записей
def create_dictionary_entries(db, concept_id, concept_name):
    # Для каждого поддерживаемого языка создаем запись
    # Пока используем оригинальное название для всех языков
    languages = db.query(LanguageModel).all()
    for language in languages:
        dictionary = DictionaryModel(
            concept_id=concept_id,
            language_id=language.id,
            name=concept_name,
            description=""  # Можно добавить характеристики позже
        )
        db.add(dictionary)
```

### 2. Интеграция с существующей системой

Добавить вызов нового скрипта в основной `seed_data.py`:

```python
def seed_domain_concepts(db):
    """Импортировать и запустить seed доменных концепций"""
    from scripts.seed_domain_concepts import seed_domain_concepts as seed_domain
    seed_domain(db)

def main():
    # ... существующие вызовы ...
    seed_domain_concepts(db)  # NEW: Доменные концепции
```

### 3. Обработка характеристик

Характеристики (min/max значения) могут быть сохранены в:
- Поле `description` модели `DictionaryModel` в формате JSON
- Или в отдельной таблице при необходимости расширенной аналитики

## Детализированный план реализации

### Этап 1: Разработка скрипта инициализации (2 дня)
1. **Анализ структуры данных** (0.5 дня)
   - Изучение формата `parser/output.json`
   - Определение правил преобразования идентификаторов
   - Определение формата хранения характеристик

2. **Разработка рекурсивного процессора** (1 день)
   - Функция обработки узлов онтологии
   - Создание концепций с правильной иерархией
   - Обработка дубликатов и проверка существующих данных

3. **Реализация словарных записей** (0.5 дня)
   - Создание записей для всех поддерживаемых языков
   - Хранение количественных характеристик
   - Оптимизация производительности для большого объема данных

### Этап 2: Интеграция и тестирование (1 день)
1. **Интеграция в существующую систему** (0.5 дня)
   - Добавление в основной скрипт `seed_data.py`
   - Проверка совместимости с существующими данными
   - Реализация защиты от повторной инициализации

2. **Тестирование** (0.5 дня)
   - Проверка корректности иерархии
   - Валидация словарных записей
   - Тестирование производительности на полном наборе данных

## Технические особенности

### Идентификаторы и пути
- Использовать существующий формат `path` (например, `1.1.1.1.1.1.1.1.`)
- Глубина иерархии определяется автоматически на основе структуры

### Многоязычная поддержка
- Поддерживать все языки из `LanguageModel`
- Названия концепций сохранять в `DictionaryModel`
- Для каждого языка создавать отдельную запись

### Хранение характеристик
- Min/max значения сохранять в JSON-формате в поле `description` словарной записи
- Формат: `{"characteristic": {"min": 120, "max": 140}}`

### Производительность
- Использовать пакетную вставку данных
- Оптимизировать рекурсивные вызовы
- Реализовать прогресс-бар для отслеживания процесса

## Риски и митигация

### Основные риски:
1. **Объем данных** - около 25,000 записей может занять значительное время
2. **Память** - рекурсивная обработка большой структуры
3. **Целостность данных** - необходимость соблюдения ссылочной целостности

### Меры по снижению рисков:
1. **Пакетная обработка** - разбиение на порции для вставки
2. **Контроль памяти** - освобождение промежуточных данных
3. **Транзакционность** - откат при ошибках
4. **Логирование** - подробное логирование процесса

## Ожидаемые результаты

### После инициализации:
- В таблице `concepts` - около 25,000 записей с правильной иерархией
- В таблице `dictionaries` - около 200,000 словарных записей (25,000 концепций × 8 языков)
- Корректная структура путей и уровней вложенности
- Сохраненные количественные характеристики

### Совместимость:
- Полная совместимость с существующими API
- Возможность работы через стандартные интерфейсы
- Поддержка всех существующих функций (поиск, фильтрация, навигация)

## Следующие шаги

1. **Утверждение плана** - согласование подхода с командой
2. **Начало реализации** - создание скрипта инициализации
3. **Тестирование на подмножестве данных** - проверка корректности подхода
4. **Полная инициализация** - запуск на полном наборе данных
5. **Валидация результатов** - проверка корректности импортированных данных