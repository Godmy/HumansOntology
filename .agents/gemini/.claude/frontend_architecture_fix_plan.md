# План исправления ошибок после обновления архитектуры фронтенда

Этот план описывает шаги по устранению критических ошибок, возникающих после обновления архитектуры фронтенда, согласно предоставленным логам консоли.

## 1. Проблема: Ошибка `NoneType` при загрузке ролей (`_map_role_to_gql`)

**Описание:** При попытке загрузить роли пользователя после логина возникает ошибка `Error: 'NoneType' object has no attribute '_map_role_to_gql'`. Это указывает на то, что `GraphQLAdapter` или `PermissionService` получает `null` вместо ожидаемого объекта роли.

**Предполагаемые причины:**
*   Бэкенд возвращает `null` или некорректные данные для ролей пользователя.
*   Фронтенд не обрабатывает `null` значения для ролей перед попыткой их маппинга.

**Шаги по исправлению:**
1.  **Исследование бэкенда:**
    *   Проверить логи бэкенда на наличие ошибок, связанных с получением или сериализацией ролей при запросе аутентификации.
    *   Убедиться, что API `/graphql` возвращает корректные данные о ролях для аутентифицированного пользователя. Возможно, для некоторых пользователей роли отсутствуют или имеют неожиданный формат.
2.  **Обработка `null` в фронтенде:**
    *   В файлах `packages/frontend/src/lib/api/GraphQLAdapter.ts` и `packages/frontend/src/lib/services/PermissionService.ts` добавить явные проверки на `null` или `undefined` для данных о ролях, прежде чем пытаться вызвать метод `_map_role_to_gql` или другие операции с объектом роли.
    *   Реализовать логику по умолчанию или обработку ошибок, если роли не получены (например, назначить минимальные права или отобразить предупреждение).
3.  **Тестирование:**
    *   Проверить процесс логина с различными тестовыми пользователями (с разными ролями и без ролей), чтобы убедиться, что ошибка `NoneType` больше не возникает и роли корректно загружаются или обрабатываются.

## 2. Проблема: Ошибки `net::ERR_ABORTED 500` при загрузке Svelte компонентов

**Описание:** После успешного логина и попытки навигации, приложение не может загрузить динамически импортируемые Svelte компоненты (например, `Tab.svelte`, `Button.svelte`), что приводит к ошибкам `net::ERR_ABORTED 500 (Internal Server Error)` и `TypeError: Failed to fetch dynamically imported module`.

**Предполагаемые причины:**
*   Некорректные пути импорта компонентов после изменения архитектуры или рефакторинга.
*   Проблемы с конфигурацией SvelteKit или Vite, влияющие на процесс сборки или динамического импорта модулей.
*   Поврежденный кэш сборки SvelteKit.

**Шаги по исправлению:**
1.  **Проверка путей импорта компонентов:**
    *   Тщательно проверить все пути импорта для компонентов, указанных в логах (`src/shared/ui/organisms/Tabs/Tab.svelte`, `src/lib/components/ui/CopyButton.svelte`, `src/lib/components/ui/Alert.svelte`, `src/lib/components/ui/Button.svelte` и т.д.).
    *   Убедиться, что пути соответствуют новой структуре файлов и что все алиасы импорта (если используются) корректно настроены в `svelte.config.js` и `vite.config.ts`.
2.  **Очистка кэша и пересборка проекта:**
    *   Остановить dev-сервер.
    *   Удалить директории сборки и кэша SvelteKit: `rm -rf packages/frontend/.svelte-kit/ packages/frontend/build/`.
    *   Переустановить зависимости (если есть подозрения на их повреждение): `cd packages/frontend && yarn install`.
    *   Запустить dev-сервер снова: `yarn dev`.
3.  **Проверка конфигурации SvelteKit/Vite:**
    *   Изучить `packages/frontend/svelte.config.js` и `packages/frontend/vite.config.ts` на предмет любых изменений, которые могли повлиять на разрешение модулей или динамический импорт.
    *   Убедиться, что плагины SvelteKit и Vite правильно настроены и обновлены до совместимых версий.
4.  **Изолированное тестирование компонентов:**
    *   Создать временную тестовую страницу, которая импортирует и отображает только один из проблемных компонентов (например, `Button.svelte`), чтобы проверить, загружается ли он корректно в изоляции. Это поможет определить, является ли проблема общей для всех компонентов или связана с конкретным контекстом их использования.

## 3. Общие рекомендации

*   **Контроль версий:** Убедиться, что все изменения архитектуры были зафиксированы в системе контроля версий, чтобы при необходимости можно было легко откатиться к стабильной версии.
*   **Документация:** Обновить внутреннюю документацию по архитектуре фронтенда и процессу сборки, если были внесены значительные изменения, чтобы предотвратить подобные проблемы в будущем.
