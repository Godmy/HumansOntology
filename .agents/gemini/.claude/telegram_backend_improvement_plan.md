# План по интеграции Telegram в бэкенд HumansOntology

Этот документ описывает план работ по интеграции функциональности Telegram-бота в бэкенд проекта HumansOntology. План представлен в виде пользовательских историй (User Stories), сгруппированных по функциональным блокам. Каждая история содержит задачи, оценку в Story Points (SP) и комментарии.

**Оценка в Story Points (SP)**: Используется шкала, подобная числам Фибоначчи (1, 2, 3, 5, 8, 13), где 1 SP — очень простая задача, а 13 — очень сложная и трудоёмкая.

---

## 1. Базовая интеграция и настройка (Истории 1-5)

### US-1: Настройка окружения для Telegram-бота
**Как разработчик, я хочу настроить базовую инфраструктуру для Telegram-бота, чтобы он мог подключаться к API Telegram и обрабатывать входящие сообщения.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-1.1:** Создать нового бота в BotFather и получить токен. | 1 | Необходимо безопасно сохранить токен в конфигурации бэкенда. |
| **T-1.2:** Выбрать и интегрировать библиотеку для работы с Telegram API (например, `python-telegram-bot` или `aiogram`). | 3 | Интеграция в существующую структуру `packages/backend`, настройка зависимостей. |
| **T-1.3:** Реализовать базовый обработчик команды `/start`. | 1 | Бот должен отвечать на команду `/start` приветственным сообщением. |
| **T-1.4:** Настроить вебхуки или long-polling для получения обновлений от Telegram. | 3 | Выбор и реализация наиболее подходящего для архитектуры проекта способа. Вебхуки предпочтительнее для продакшена. |
| **T-1.5:** Добавить логирование всех входящих сообщений и действий бота. | 2 | Интеграция с существующей системой логирования проекта. |

### US-2: Связь пользователя Telegram с профилем в системе
**Как пользователь, я хочу привязать свой Telegram-аккаунт к моему профилю в HumansOntology, чтобы получать персонализированные уведомления и доступ к данным.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-2.1:** Добавить в модель пользователя поле для хранения `telegram_user_id`. | 2 | Включает создание миграции базы данных. |
| **T-2.2:** Реализовать команду `/connect <one_time_code>`, где код генерируется в веб-интерфейсе. | 5 | Требует доработки фронтенда и бэкенда для генерации и проверки кода. |
| **T-2.3:** Реализовать команду `/disconnect` для отвязки аккаунта. | 2 | Пользователь должен иметь возможность разорвать связь. |

### US-3: Управление подписками на уведомления
**Как пользователь, я хочу управлять типами уведомлений, которые я получаю в Telegram, чтобы не получать лишнюю информацию.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-3.1:** Создать в БД таблицу для хранения настроек подписок пользователя. | 2 | Модель `UserNotificationSettings` со связью `user_id` и типами уведомлений. |
| **T-3.2:** Реализовать команду `/settings` с выводом inline-кнопок для управления подписками. | 5 | Требует реализации callback-обработчиков для кнопок (вкл/выкл разных типов нотификаций). |

### US-4: Получение основной информации о профиле
**Как пользователь, я хочу запросить основную информацию о своем профиле через команду `/me`, чтобы быстро получить сводку.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-4.1:** Реализовать команду `/me`, которая выводит информацию из профиля пользователя. | 3 | Имя, email, роль и другие ключевые поля из профиля HumansOntology. |

### US-5: Помощь и документация по боту
**Как пользователь, я хочу получить помощь по доступным командам бота через команду `/help`.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-5.1:** Реализовать команду `/help`, которая выводит список доступных команд и их описание. | 2 | Текст помощи должен быть легко расширяемым при добавлении новых функций. |

---

## 2. Взаимодействие с онтологией и базой знаний (Истории 6-15)

### US-6: Поиск сущностей в онтологии
**Как пользователь, я хочу искать людей, проекты или другие сущности в онтологии по ключевому слову.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-6.1:** Реализовать команду `/search <query>`. | 5 | Интеграция с поисковым движком (Elasticsearch, если есть) или реализация поиска на уровне БД. |
| **T-6.2:** Форматировать результаты поиска в виде кратких карточек. | 3 | Вывод ключевой информации и кнопки для просмотра деталей. |
| **T-6.3:** Добавить пагинацию для результатов поиска. | 3 | Использование inline-кнопок "Вперед" / "Назад". |

### US-7: Просмотр детальной информации о сущности
**Как пользователь, я хочу просматривать детальную информацию о найденной сущности, нажав на кнопку в результатах поиска.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-7.1:** Реализовать callback-обработчик для кнопки "Подробнее". | 3 | Запрос полной информации о сущности по ее ID. |
| **T-7.2:** Разработать шаблон для вывода полной информации о сущности. | 3 | Включая связанные сущности (например, проекты человека). |

### US-8: Быстрое добавление факта в онтологию
**Как пользователь, я хочу быстро добавить новый факт или связь между сущностями через бота.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-8.1:** Реализовать команду `/add_fact` в формате `<сущность1> <связь> <сущность2>`. | 8 | Требует парсинга строки, поиска сущностей и создания новой связи в БД. Нужна валидация. |
| **T-8.2:** Добавить диалоговый режим для добавления фактов (FSM). | 13 | Бот последовательно задает вопросы: "Укажите первую сущность", "Укажите тип связи", "Укажите вторую сущность". |

### US-9: Подписка на обновления сущности
**Как пользователь, я хочу подписаться на обновления конкретной сущности (человека, проекта), чтобы получать уведомления об изменениях.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-9.1:** Реализовать кнопку "Подписаться" на карточке сущности. | 3 | Добавление записи в таблицу подписок `entity_subscriptions`. |
| **T-9.2:** Создать фоновую задачу (Celery), которая рассылает уведомления при изменении сущности. | 5 | Интеграция с сигналами ORM (если возможно) или ручная отправка после изменения. |

### US-10: Запрос визуализации графа связей
**Как пользователь, я хочу запросить визуализацию связей для конкретной сущности и получить изображение графа.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-10.1:** Интегрировать библиотеку для генерации графов (например, `graphviz` или `matplotlib`). | 5 | Настроить генерацию изображения графа по данным из онтологии. |
| **T-10.2:** Реализовать команду `/graph <entity_name>`. | 8 | Команда запускает генерацию и отправляет готовое изображение пользователю. Может быть долгой операцией. |

### US-11: Получение случайного факта из онтологии
**Как пользователь, я хочу получать интересный случайный факт из базы знаний командой `/random_fact`.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-11.1:** Реализовать команду `/random_fact`. | 3 | Выбор случайной связи или факта из БД и форматирование для вывода. |

### US-12: Поиск по тегам
**Как пользователь, я хочу найти все сущности, связанные с определенным тегом.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-12.1:** Реализовать команду `/find_by_tag <tag>`. | 3 | Поиск по таблице тегов и связанных с ними сущностей. |

### US-13: Предложение синонима для сущности
**Как пользователь, я хочу предложить альтернативное имя (синоним) для сущности, чтобы улучшить поиск.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-13.1:** Реализовать команду `/suggest_synonym <entity_name> = <synonym>`. | 5 | Создание "предложения на модерацию", которое администратор может одобрить. |

### US-14: Запрос статистики по онтологии
**Как администратор, я хочу получать основную статистику по базе знаний (количество сущностей, связей).**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-14.1:** Реализовать команду `/stats`, доступную только администраторам. | 3 | Сбор и вывод статистики. |

### US-15: Поиск похожих сущностей
**Как пользователь, я хочу найти сущности, похожие на данную (например, люди с похожими навыками).**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-15.1:** Реализовать команду `/find_similar <entity_name>`. | 8 | Требует реализации или использования алгоритма подобия (например, на основе общих тегов или связей). |

---

## 3. Уведомления и оповещения (Истории 16-25)

### US-16: Уведомление о новом комментарии
**Как пользователь, я хочу получать уведомление в Telegram, когда кто-то оставляет комментарий к сущности, на которую я подписан.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-16.1:** Создать обработчик, который отправляет уведомление автору и подписчикам. | 3 | Интеграция с логикой добавления комментариев. |

### US-17: Уведомление об упоминании в системе
**Как пользователь, я хочу получать уведомление, когда меня упоминают (@username) в описании или комментарии.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-17.1:** Реализовать парсинг текста на предмет упоминаний при сохранении. | 5 | Отправка уведомления упомянутому пользователю, если у него привязан Telegram. |

### US-18: Ежедневная сводка обновлений
**Как пользователь, я хочу получать ежедневную сводку (дайджест) об изменениях в сущностях, на которые я подписан.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-18.1:** Создать периодическую задачу (Celery beat) для сбора обновлений. | 5 | Задача должна запускаться раз в день. |
| **T-18.2:** Сформировать и отправить персональный дайджест каждому подписчику. | 5 | Агрегация данных и форматирование сообщения. |

### US-19: Уведомление о добавлении в проект
**Как пользователь, я хочу получить уведомление, когда меня добавляют в новый проект.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-19.1:** Интегрировать отправку уведомлений в логику добавления участника в проект. | 3 | Уведомление должно содержать ссылку на проект. |

### US-20: Напоминание о задачах
**Как пользователь, я хочу получать напоминания о задачах, у которых подходит срок выполнения.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-20.1:** Создать периодическую задачу для проверки сроков задач. | 5 | Проверка задач, у которых `due_date` сегодня или завтра. |
| **T-20.2:** Отправлять напоминания исполнителям задач. | 3 | |

### US-21: Уведомления о системных событиях
**Как администратор, я хочу получать уведомления о критических ошибках или событиях в системе.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-21.1:** Настроить отправку уведомлений в специальный канал для администраторов. | 3 | Интеграция с системой мониторинга ошибок (например, Sentry). |

### US-22: Уведомление об изменении прав доступа
**Как пользователь, я хочу получать уведомление, если мои права доступа в системе были изменены.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-22.1:** Добавить отправку уведомления в логику управления ролями и правами. | 3 | |

### US-23: Уведомление о подтверждении или отклонении предложенного изменения
**Как пользователь, я хочу узнать, когда предложенный мной факт (US-13) был принят или отклонен модератором.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-23.1:** Отправлять уведомление автору предложения после модерации. | 2 | |

### US-24: Массовая рассылка от администратора
**Как администратор, я хочу иметь возможность отправить сообщение всем пользователям бота.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-24.1:** Реализовать команду `/broadcast <message>`, доступную только администраторам. | 5 | Рассылка должна происходить в фоновом режиме, чтобы не блокировать бота. |

### US-25: Уведомление о новых сущностях, соответствующих моим интересам
**Как пользователь, я хочу получать уведомления, когда в системе появляются новые сущности с тегами, на которые я подписан.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-25.1:** Реализовать подписку на теги. | 3 | |
| **T-25.2:** Отправлять уведомления при создании сущности с отслеживаемым тегом. | 5 | |

---

## 4. Администрирование и модерация (Истории 26-35)

### US-26: Просмотр списка пользователей бота
**Как администратор, я хочу видеть список пользователей, которые подключили бота.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-26.1:** Реализовать команду `/list_users` с пагинацией. | 3 | |

### US-27: Блокировка пользователя в боте
**Как администратор, я хочу иметь возможность заблокировать пользователя, чтобы он не мог использовать бота.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-27.1:** Добавить флаг `is_blocked_in_bot` в модель пользователя. | 2 | |
| **T-27.2:** Реализовать команду `/block_user <user_id>`. | 3 | |

### US-28: Просмотр предложений на модерацию
**Как модератор, я хочу получать уведомления о новых предложениях (синонимы, факты) и иметь возможность их одобрить или отклонить через бота.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-28.1:** Отправлять уведомления о новых предложениях в канал модераторов. | 3 | |
| **T-28.2:** Добавить к уведомлению inline-кнопки "Одобрить" / "Отклонить". | 5 | Реализация callback-обработчиков для модерации. |

### US-29: Получение обратной связи от пользователей
**Как пользователь, я хочу иметь возможность отправить отзыв или сообщение об ошибке разработчикам через бота.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-29.1:** Реализовать команду `/feedback <message>`. | 3 | Сообщение пересылается в специальный чат/канал для команды разработки. |

### US-30: Просмотр логов действий пользователя
**Как администратор, я хочу иметь возможность посмотреть последние действия конкретного пользователя в боте.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-30.1:** Реализовать команду `/user_log <user_id>`. | 5 | Требует наличия детального логирования действий. |

### US-31: Назначение ролей через бота
**Как администратор, я хочу назначать пользователям роли (например, 'модератор') через бота.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-31.1:** Реализовать команду `/set_role <user_id> <role_name>`. | 5 | Требует проверки прав администратора. |

### US-32: Поиск "осиротевших" сущностей
**Как администратор, я хочу находить сущности, у которых нет ни одной связи.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-32.1:** Реализовать команду `/find_orphans`. | 5 | |

### US-33: Ручной запуск фоновых задач
**Как администратор, я хочу иметь возможность вручную запустить периодическую задачу (например, рассылку дайджеста).**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-33.1:** Реализовать команду `/run_task <task_name>`. | 3 | |

### US-34: Проверка состояния системы
**Как администратор, я хочу запросить статус бэкенда и его подсистем (БД, Redis, Celery) через команду `/healthcheck`.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-34.1:** Реализовать команду `/healthcheck`. | 5 | Команда должна собирать информацию о состоянии сервисов. |

### US-35: Управление фича-флагами
**Как администратор, я хочу включать и выключать экспериментальные функции бота для всех или для части пользователей.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-35.1:** Реализовать систему фича-флагов. | 8 | |
| **T-35.2:** Реализовать команды `/feature_on <feature>` и `/feature_off <feature>`. | 5 | |

---

## 5. Социальные и командные функции (Истории 36-50)

### US-36: Создание временной группы для обсуждения
**Как пользователь, я хочу создать временную группу для обсуждения сущности с другими заинтересованными пользователями.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-36.1:** Реализовать кнопку "Обсудить" на карточке сущности. | 8 | Бот создает новую группу и приглашает в нее пользователя и, по желанию, других подписчиков сущности. |

### US-37: Проведение опросов
**Как пользователь, я хочу создать опрос, связанный с какой-либо сущностью, и пригласить других к голосованию.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-37.1:** Реализовать команду `/poll <entity_name>` для создания опроса. | 8 | Использование встроенной функциональности опросов Telegram. |

### US-38: Быстрая отправка файла, связанного с сущностью
**Как пользователь, я хочу отправить боту файл (документ, изображение), и он привяжет его к указанной сущности.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-38.1:** Реализовать обработчик входящих файлов. | 5 | Бот должен спросить, к какой сущности привязать файл. |
| **T-38.2:** Интеграция с файловым хранилищем (S3, MinIO). | 5 | |

### US-39: Запрос списка контактов по проекту
**Как участник проекта, я хочу получить список контактов (Telegram-аккаунтов) всех участников проекта.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-39.1:** Реализовать команду `/project_contacts <project_name>`. | 3 | Вывод списка участников проекта, у которых привязан Telegram. |

### US-40: Установка статуса "в сети" / "отошел"
**Как пользователь, я хочу установить свой текущий статус, чтобы коллеги видели мою доступность.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-40.1:** Реализовать команды `/online`, `/away`, `/dnd`. | 3 | Статус отображается в профиле пользователя в веб-интерфейсе. |

### US-41: Поиск эксперта по теме
**Как пользователь, я хочу найти эксперта в определенной области, используя теги навыков.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-41.1:** Реализовать команду `/find_expert <skill_tag>`. | 5 | Поиск пользователей с наибольшим количеством подтвержденных навыков по тегу. |

### US-42: Отправка "благодарности" другому пользователю
**Как пользователь, я хочу отправить "спасибо" другому пользователю за помощь, что будет учтено в его профиле.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-42.1:** Реализовать команду `/thank <@user> for <reason>`. | 5 | Увеличивает счетчик "благодарностей" в профиле пользователя. |

### US-43: Создание личной заметки о сущности
**Как пользователь, я хочу создать приватную заметку к сущности, видимую только мне.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-43.1:** Реализовать команду `/add_note <entity_name> <text>`. | 5 | Заметки хранятся в отдельной таблице с привязкой к пользователю и сущности. |

### US-44: Просмотр своих заметок
**Как пользователь, я хочу просмотреть все свои личные заметки.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-44.1:** Реализовать команду `/my_notes`. | 3 | |

### US-45: Интеграция с календарем
**Как пользователь, я хочу, чтобы события и дедлайны из HumansOntology автоматически добавлялись в мой Google/Outlook календарь.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-45.1:** Реализовать OAuth2 интеграцию с сервисами календарей. | 13 | Очень сложная задача, требующая серьезной проработки безопасности. |
| **T-45.2:** Отправлять `.ics` файлы в качестве альтернативы. | 5 | Более простая реализация: бот генерирует файл события, который пользователь может импортировать вручную. |

### US-46: Геймификация: получение достижений
**Как пользователь, я хочу получать "ачивки" за активное использование системы (добавление фактов, помощь другим).**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-46.1:** Разработать систему достижений и критериев их получения. | 8 | |
| **T-46.2:** Отправлять уведомления о получении нового достижения. | 3 | |

### US-47: Запрос "Кто знает о...?"
**Как пользователь, я хочу отправить в общий чат вопрос "Кто знает о <тема>?" и бот должен тегнуть наиболее релевантных экспертов.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-47.1:** Реализовать обработчик такого сообщения в групповом чате. | 8 | Требует, чтобы бот был добавлен в чат. Поиск экспертов аналогичен US-41. |

### US-48: Умное кеширование ответов
**Как разработчик, я хочу, чтобы бот кешировал часто запрашиваемые данные (например, информацию о популярных сущностях), чтобы отвечать быстрее.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-48.1:** Интегрировать Redis для кеширования ответов API. | 5 | |

### US-49: Поддержка нескольких языков
**Как пользователь, я хочу взаимодействовать с ботом на своем родном языке.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-49.1:** Интегрировать систему локализации (i18n) в бота. | 8 | Все строки бота должны быть переводимыми. |
| **T-49.2:** Добавить команду `/language` для смены языка. | 2 | |

### US-50: Telegram Mini App для сложного интерфейса
**Как пользователь, я хочу использовать сложный интерфейс (например, редактирование графа) прямо в Telegram.**

| Задача | SP | Комментарий |
| :--- | :-: | :--- |
| **T-50.1:** Разработать простое веб-приложение (Mini App) для отображения графа. | 13 | Требует знаний фронтенд-разработки и Telegram Mini Apps API. |
| **T-50.2:** Реализовать кнопку, открывающую это Mini App. | 3 | |
