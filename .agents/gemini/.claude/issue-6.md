# Задача для Claude Sonnet 4.5: Улучшение работы с базой данных

**Обзор:**
Эта задача направлена на значительное улучшение взаимодействия с базой данных в бэкенд-приложении, охватывая оптимизацию запросов, инструменты миграции данных и автоматизированное резервное копирование/восстановление. Цель — повысить производительность, надежность и управляемость данных.

**Контекст системы:**
*   **Язык:** Python
*   **Фреймворк:** Starlette
*   **ORM:** SQLAlchemy
*   **База данных:** PostgreSQL
*   **Миграции БД:** Alembic
*   **CLI:** `click` (файл `packages/backend/cli.py`)
*   **Логирование:** Структурированное логирование с `python-json-logger` (файл `packages/backend/core/structured_logging.py`). Существует функция `log_database_query` для логирования запросов и медленных запросов.
*   **Мониторинг:** Sentry (`sentry-sdk[starlette,sqlalchemy]`) и Prometheus (`prometheus-client`) используются для мониторинга.
*   **GraphQL:** `strawberry-graphql`
*   **Структура проекта:** Монорепозиторий с `packages/backend` для бэкенда.

**Текущий статус реализации (что уже есть):**

*   **Оптимизация запросов:**
    *   Использование `joinedload` в некоторых местах (`auth/services/admin_service.py`, `languages/services/dictionary_service.py`, `languages/services/search_service.py`) указывает на осведомленность о проблеме N+1.
*   **Инструменты миграции данных:**
    *   Команды `backup-db` и `restore-db` в `packages/backend/cli.py` для ручного полного дампа/восстановления БД с использованием `pg_dump` и `psql`.
    *   Команда `seed_data` в `packages/backend/cli.py` имеет режим `dry-run`.
*   **Автоматическое резервное копирование:**
    *   Ручные команды `backup-db` и `restore-db` существуют.

**Что необходимо реализовать (Acceptance Criteria для Claude):**

**1. Оптимизация запросов и предотвращение N+1 (#24)**
*   **SQLAlchemy relationship lazy loading review:** Провести полный аудит использования `lazy loading` в SQLAlchemy-моделях и запросах.
*   **Добавить joinedload/subqueryload где нужно:** Расширить использование `joinedload` и `subqueryload` для всех критических запросов, где это необходимо для предотвращения N+1 проблем.
*   **Query logging в DEBUG mode:** Интегрировать существующую функцию `log_database_query` из `core/structured_logging.py` с механизмом выполнения запросов SQLAlchemy, чтобы все запросы логировались на уровне DEBUG. Убедиться, что `echo=False` в `core/database.py` не препятствует этому, возможно, используя события SQLAlchemy.
*   **Monitoring slow queries (>100ms):** Интегрировать логику мониторинга медленных запросов (уже существующую в `log_database_query`) с SQLAlchemy, чтобы автоматически логировать предупреждения для запросов, превышающих 100 мс.
*   **Indexes для часто используемых полей:** Проанализировать наиболее часто используемые поля в запросах и добавить необходимые индексы в SQLAlchemy-модели (через `__table_args__` или `Index`).
*   **Database query profiling tools:** Исследовать и предложить интеграцию дополнительных инструментов для профилирования запросов, если Sentry и Prometheus недостаточно для глубокого анализа.
*   **GraphQL DataLoader integration:** Реализовать интеграцию GraphQL DataLoader для оптимизации запросов к БД, выполняемых через GraphQL API, чтобы избежать N+1 проблем на уровне GraphQL.

**2. Инструменты миграции данных (#34)**
*   **Selective export (по entities, dates, filters):** Разработать CLI-команды для выборочного экспорта данных (например, по определенным сущностям, диапазонам дат или с использованием фильтров).
*   **Data transformation при миграции:** Предусмотреть механизм для трансформации данных во время миграции (например, изменение формата полей, анонимизация).
*   **Dry-run mode для проверки:** Расширить режим `dry-run` для команд экспорта/импорта данных, чтобы можно было проверить результат без фактического изменения БД.
*   **Rollback mechanism:** Реализовать механизм отката для операций миграции данных.
*   **Progress reporting для больших datasets:** Добавить отчет о прогрессе для операций с большими наборами данных.

**3. Автоматическое резервное копирование и восстановление (#27)**
*   **Daily backups в S3/local storage:** Реализовать автоматическое ежедневное резервное копирование базы данных. Бэкапы должны сохраняться как локально, так и, при наличии конфигурации, в S3-совместимое хранилище.
*   **Retention policy (7 daily, 4 weekly, 12 monthly):** Внедрить политику хранения резервных копий (например, 7 ежедневных, 4 еженедельных, 12 ежемесячных).
*   **Point-in-time recovery:** Исследовать и реализовать возможность восстановления базы данных на определенный момент времени.
*   **Backup verification (restore test):** Разработать механизм для автоматической проверки целостности резервных копий (например, путем восстановления в тестовую БД).
*   **Celery task для scheduled backups:** Предполагается Celery для планирования и выполнения автоматических резервных копий. Представь, что `celery` уже есть в `requirements.txt`.
*   **CLI command для manual backup/restore:** Существующие команды `backup-db` и `restore-db` должны быть улучшены для поддержки новых функций (например, выбор места хранения, применение политики хранения).

**Ожидаемый результат:**
*   Обновленный код бэкенда с реализованными функциями.
*   Обновленная документация, описывающая новые CLI-команды, конфигурацию и принципы работы.
*   Добавление необходимых зависимостей в `requirements.txt`.
*   Примеры использования новых функций.

**Приоритет:** Высокий.
**Оценка трудозатрат:** 8 story points (как указано в исходных задачах).

---
**Дополнительная информация для Claude:**

*   **Файлы для изучения:**
    *   `packages/backend/requirements.txt`: Список зависимостей.
    *   `packages/backend/cli.py`: Существующие CLI-команды.
    *   `packages/backend/core/config.py`: Конфигурация приложения.
    *   `packages/backend/core/database.py`: Настройка подключения к БД.
    *   `packages/backend/core/structured_logging.py`: Система логирования.
    *   `packages/backend/auth/models/user.py`, `packages/backend/languages/models/concept.py` (и другие модели): Примеры SQLAlchemy-моделей.
    *   `packages/backend/auth/services/admin_service.py`, `packages/backend/languages/services/dictionary_service.py`: Примеры использования `joinedload`.

*   **Рекомендации:**
    *   Для интеграции логирования запросов SQLAlchemy рассмотрите использование событий SQLAlchemy (например, `before_cursor_execute`, `after_cursor_execute`) для перехвата запросов и передачи их в `log_database_query`.
    *   Для автоматического резервного копирования и Celery, возможно, потребуется добавить новые файлы конфигурации и модули.
    *   При работе с S3 используйте библиотеку `boto3`.
    *   При создании новых CLI-команд следуйте существующему стилю в `cli.py` с использованием `click`.
    *   Все изменения должны соответствовать существующим стандартам кодирования и архитектуре проекта.
